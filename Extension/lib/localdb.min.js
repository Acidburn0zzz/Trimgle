!function(){"use strict";var e=":",t={version:"1.0.1.1",author:"Leonardo Ciaccio",contact:"leonardo.ciaccio@gmail.com",license:"MIT",credits:["code.google.com/p/crypto-js","https://github.com/calvinmetcalf/lie"]},n={encrypt:function(e,t,n){return n||(n=e.password),n?CryptoJS.AES.encrypt(t,n):t},decrypt:function(e,t,n){return n||(n=e.password),n?CryptoJS.AES.decrypt(t,n).toString(CryptoJS.enc.Utf8):t},getNextID:function(e,t){var o=n.getDBtable(e,t);return o?o.length>0?o.sort(function(e,t){return t["#"]-e["#"]})[0]["#"]+1:0:null},isJSON:function(e){try{return JSON.parse(e())}catch(t){return null}},isUnique:function(e,t){return!t.unique||""==t.unique||e.every(function(e){return!e.unique||e.unique!=t.unique})},setDBtable:function(t,o,i){i=i||[];var r=t.storage,a=t.name,c=a+e+o;try{var s=n.encrypt(t,JSON.stringify(i));return s||(s=JSON.stringify(i)),r[c]=s,!0}catch(l){return!1}},getDBtable:function(t,o){var i=t.storage,r=t.name,a=r+e+o;return"undefined"==typeof i[a]?[]:this.isJSON(function(){try{var e=n.decrypt(t,i[a]);return e?e:i[a]}catch(o){return i[a]}})},deepMerge:function(e,t){for(var n in t)try{e[n]=t[n].constructor==Object?deepMerge(e[n],t[n]):t[n]}catch(o){e[n]=t[n]}return e}},o=function(e){return"object"!=typeof e&&(e={}),this.storage=e.storage!=localStorage&&e.storage!=sessionStorage?localStorage:e.storage,this.name="string"!=typeof e.name||""==e.name?"localdbclass":e.name,this.change="function"!=typeof e.change?function(){}:e.change,this.password=null,this.dev=t,this};o.prototype.add=function(e,t){if(!e)throw new Error("localdbclass.prototype.add : 'tablename' required !");var o=this;return new Promise(function(i,r){t=Array.isArray(t)?t:[t];var a=n.getDBtable(o,e);if(!a)return r(100);for(var c=[],s=0;s<t.length;s++){var l=t[s];if(n.isUnique(a,l)){var u=n.getNextID(o,e);if(null!==u){var m=n.deepMerge(l,{"#":u});a.push(m),c.push(m)}}}var h=n.setDBtable(o,e,a);return h?(o.change(e,c,"add",a),i(c)):r(101)})},o.prototype.update=function(e,t){if(!e)throw new Error("localdbclass.prototype.update : 'tablename' required !");var o=this;return new Promise(function(i,r){t=Array.isArray(t)?t:[t];var a=n.getDBtable(o,e);if(!a)return r(100);for(var c=[],s=0,l=0;l<a.length&&s<t.length;l++)for(var u=0;u<t.length;u++){var m=t[u];if(a[l]["#"]==m["#"]){s++;var h=a.slice();if(h.splice(l,1),!n.isUnique(h,m))continue;a[l]=n.deepMerge(a[l],m),c.push(a[l])}}var p=n.setDBtable(o,e,a);return p?(o.change(e,c,"update",a),i(c)):r(101)})},o.prototype.remove=function(e,t){if(!e)throw new Error("localdbclass.prototype.remove : Table name required !");var o=this;return new Promise(function(i,r){t=Array.isArray(t)?t:[t];var a=n.getDBtable(o,e);if(!a)return r(100);for(var c=[],s=0;s<t.length;s++){var l=a.findIndex(function(e){return e["#"]==t[s]});l>-1&&(c.push(a[l]),a.splice(l,1))}var u=n.setDBtable(o,e,a);return u?(o.change(e,c,"remove",a),i(c)):r(101)})},o.prototype.move=function(e,t,o){if(!e)throw new Error("localdbclass.prototype.move : Table name required !");if(!(t>-1&&o>-1))throw new Error("localdbclass.prototype.move : ID required !");var i=this;return new Promise(function(r,a){var c=n.getDBtable(i,e);if(!c)return a(100);var s=c.findIndex(function(e){return o==e["#"]});if(0>s)return a(4);var l=c.findIndex(function(e){return t==e["#"]});if(0>l)return a(5);if(l==s)return a(6);var u=c.splice(l,1);c.splice(s,0,u[0]);var m=n.setDBtable(i,e,c);return m?(i.change(e,u,"move",c),r(u)):a(101)})},o.prototype.invert=function(e,t,o){if(!e)throw new Error("localdbclass.prototype.invert : Table name required !");if(!(t>-1&&o>-1))throw new Error("localdbclass.prototype.invert : ID required !");var i=this;return new Promise(function(r,a){var c=n.getDBtable(i,e);if(!c)return a(100);var s=c.findIndex(function(e){return o==e["#"]});if(0>s)return a(4);var l=c.findIndex(function(e){return t==e["#"]});if(0>l)return a(5);if(l==s)return a(6);var u,m;l>s?(u=c.splice(l,1),m=c.splice(s,1),c.splice(s,0,u[0]),c.splice(l,0,m[0])):(m=c.splice(s,1),u=c.splice(l,1),c.splice(l,0,m[0]),c.splice(s,0,u[0]));var h=n.setDBtable(i,e,c);return h?(i.change(e,[u,m],"invert",c),r([u,m])):a(101)})},o.prototype.query=function(e,t,o){if(!e)throw new Error("localdbclass.prototype.query : Table name required !");var i=this;return new Promise(function(r,a){"function"!=typeof t&&(t=function(){return!0}),o||(o={}),o.offset=o.offset&&parseInt(o.offset)>0?parseInt(o.offset):0,o.limit=o.limit&&parseInt(o.limit)>0?parseInt(o.limit):-1,"disc"!==o.sort&&(o.sort="asc");var c=[],s=n.getDBtable(i,e);if(!s)return a(100);s.slice();o.sortby&&"string"==typeof o.sortby&&s.sort("asc"==o.sort?function(e,t){return"string"==typeof e[o.sortby]&&"string"==typeof t[o.sortby]?e[o.sortby].localeCompare(t[o.sortby]):parseInt(e[o.sortby])-parseInt(t[o.sortby])}:function(e,t){return"string"==typeof e[o.sortby]&&"string"==typeof t[o.sortby]?t[o.sortby].localeCompare(e[o.sortby]):parseInt(t[o.sortby])-parseInt(e[o.sortby])});for(var l=o.offset;l<s.length&&(o.limit<0||l<o.limit);l++){var u=s[l];t(u)===!0&&c.push(u)}return r(c)})},o.prototype.encryptdb=function(e){var t=this;return new Promise(function(o,i){var r=t.storage,a={};for(var c in r)if(c.match(new RegExp("^"+t.name,"g")))try{var s=n.encrypt(t,r[c],e);if(!s)return i();a[c]=s}catch(l){return i()}for(var c in a)r[c]=a[c];return o()})},o.prototype.decryptdb=function(e){var t=this;return new Promise(function(o,i){var r=t.storage,a={};for(var c in r)if(c.match(new RegExp("^"+t.name,"g"))){try{if(JSON.parse(r[c])){a[c]=r[c];continue}}catch(s){}try{var l=n.decrypt(t,r[c],e);if(l){if(JSON.parse(l)){a[c]=l;continue}return i()}return i()}catch(s){return i()}}for(var c in a)r[c]=a[c];return o()})},o.prototype.getTable=function(e){if(!e)throw new Error("localdbclass.prototype.getTable : Table name required !");var t=this;return n.getDBtable(t,e)},o.prototype.countRecords=function(e){if(!e)throw new Error("localdbclass.prototype.countRecords : Table name required !");var t=this;return new Promise(function(o,i){var r=n.getDBtable(t,e);return r?o(r.length):i(100)})},o.prototype.export=function(){var e=this;return new Promise(function(t){var n=e.storage,o=[];for(var i in n)if(i.match(new RegExp("^"+e.name,"g"))){var r={};r[i]=n[i],o.push(r)}o.length<1&&t(null),t(JSON.stringify(o))})},o.prototype.import=function(e){var t=this;return new Promise(function(n,o){var i=t.storage;if("string"!=typeof e)throw new Error("localdbclass.prototype.import : require text format alldb");try{var r=JSON.parse(e);r.forEach(function(e){try{i[Object.keys(e)]=e[Object.keys(e)]}catch(t){}})}catch(a){o("localdbclass.prototype.import : problems on import")}n()})},o.prototype.clear=function(t){var n=this;return new Promise(function(o){var i=n.storage;for(var r in i)(t&&r.match(new RegExp("^"+n.name+e+t.toString()+"$","g"))||!t&&r.match(new RegExp("^"+n.name,"g")))&&i.removeItem(r);n.change(t,[],"clear",[]),o(n.name)})},o.prototype.isEncrypted=function(){var e=this;return new Promise(function(t){var o=e.storage,i=0,r=0;for(var a in o)a.match(new RegExp("^"+e.name,"g"))&&(i++,null===n.isJSON(function(){try{var e=decrypt(o[a]);return e?e:o[a]}catch(t){return o[a]}})&&r++);t([i,r])})},window.localdb=o}();
//# sourceMappingURL=localdb.min.js.map