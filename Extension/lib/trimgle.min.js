!function(e,t,n){"use strict";if(!e)throw new Error("jQuery required");if(!t)throw new Error("LocalDB required");if(!n)throw new Error("j2h required");var i="Timgle DB",o=!1,r=function(e){var e=(new Date).toLocaleString()+" : "+e;o===!0&&console.log(e)},a={settings:"Settings",elements:"Elements",toReview:"To Review",toWatch:"To Watch"},c={m1:6e4,m5:3e5,m15:9e5,m30:18e5,h1:36e5,h6:216e5,h12:432e5,h24:864e5},u={"#":null,notification:!0,sendAnonInfo:!0,lastNews:"https://www.facebook.com/Trimgle/",oldNews:""},l={"#":null,title:"",page:"",description:"",type:"html",favicon:"",selector:"",interval:"m30",newest:[],oldest:[],pinglist:[],addeded:0,pinged:0},d={title:"",link:"",text:""},s=new t({storage:localStorage,name:i,change:function(t,n,i,o){t==a.toReview?(w(i,o),r("_onReviewChange : "+t)):t==a.toWatch?(y(i,o),r("_onWatchChange : "+t)):t!=a.elements||"remove"!=i&&"clear"!=i||e.each(n,function(e,t){localStorage.removeItem("screenshot:"+t.addeded),r("Rimosso lo screenshot : "+t.addeded),s.query(a.toReview,function(e){return e.id==t.addeded}).then(function(e){r("Rimuovo toReview : "+e[0]["#"]),s.remove(a.toReview,e[0]["#"])}),s.query(a.toWatch,function(e){return e.id==t.addeded}).then(function(e){r("Rimuovo toWatch : "+e[0]["#"]),s.remove(a.toWatch,e[0]["#"])})})}}),f=[{interval:"m5",time:c.m5,listener:null},{interval:"m15",time:c.m15,listener:null},{interval:"m30",time:c.m30,listener:null},{interval:"h1",time:c.h1,listener:null}],g=function(e){return e?e.indexOf("#trimgle")>-1?e.replace(/\#trimgle/gi,""):e.indexOf("?")>-1?e.replace("?","?trimgle="+Date.now()+"&"):e.indexOf("#")>-1?e.replace("#","?trimgle="+Date.now()+"#"):e+"?trimgle="+Date.now():e},h=function(e){return e&&""!=e?e.replace(/(\?trimgle\=\d{0,100}&)/gi,"?").replace(/(\?trimgle\=\d{0,100}$)/gi,""):e},m=function(t){var n=[];return e.each(t,function(){var t=e(this).prop("tagName")||"";if(t&&""!=t){var i=e.extend({},d);"a"==t.toLowerCase()?(i.title=e(this).text()||"",i.title=i.title.trim(),i.link=e(this)[0].href||"",i.link=h(i.link.trim())):(i.text=e(this).text()||"",i.text=i.text.trim()),(""!=i.title&&""!=i.link||""!=i.text)&&n.push(i)}}),n},v=function(e,t){var n=function(e){return function(t){return 0==e.filter(function(e){return 0==e.link.localeCompare(t.link)&&0==e.title.localeCompare(t.title)&&0==e.text.localeCompare(t.text)}).length}},i=e.filter(n(t)),o=t.filter(n(e)),r=i.concat(o)||[];return r},p=function(){r("Eseguo il PayAttention vuoto")},w=function(){},y=function(){},b=function(e,t,n){t=t||"",n=n||0;var i=Date.now();s.add(a.toReview,{id:e.addeded,lasterror:t,status:n,when:i,title:e.title,page:e.page,desc:e.description,favicon:e.favicon}).then(function(){r(e.addeded+" inserito in review")},function(t){r(e.addeded+", non riesco ad inserirlo in review : "+t)})},x=function(t,n){if(!n)return!1;e.isArray(n)||(n=[n]);var i=Date.now();s.add(a.toWatch,{id:t.addeded,newdata:n,when:i,title:t.title,page:t.page,desc:t.description,favicon:t.favicon}).then(function(){r(t.addeded+" inserito in watchlist")},function(e){r(t.addeded+", non riesco ad inserirlo in watchlist : "+e)})},C=function(e,t){r("Chiamata al _ping() : "+e),"function"!=typeof t&&(t=function(){});var n=j();return(e=g(e))?(n.responseType="document",n.overrideMimeType("text/html"),n.open("GET",e,!0),n.onload=function(){r("ping ... : "+e),n.readyState===n.DONE&&t(n)},void n.send(null)):(t(),r("Il link ha problemi : "+e),!1)},T=function(t,n){r("Chiamata al _toPing()"),e.each(t,function(t,i){e.each(n,function(e,t){if(t.link.length>0&&t.title.length>0||t.text.length>0){var n=i.replace(/\{\%l\}/g,encodeURIComponent(t.link)).replace(/\{\%t\}/g,encodeURIComponent(t.title)).replace(/\{\%p\}/g,encodeURIComponent(t.text)).trim();setTimeout(function(){n&&""!=n&&C(n,function(){r("ping ok : "+n)})},1e3)}else r("Strano, ci sono elementi inconcruenti, vai in debug approfondito, grave !")})})},j=function(){try{return new XMLHttpRequest}catch(e){}try{return new ActiveXObject("Msxml3.XMLHTTP")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}return null},N=function(t,i,o,c,u){i=i||!1,"function"!=typeof o&&(o=function(){}),"function"!=typeof c&&(c=function(){}),"function"!=typeof u&&(u=function(){});var l=j(),d=g(t.page);return d?(t.type=t.type||"html",l.responseType="document",l.overrideMimeType("text/html"),l.open("GET",d,!0),l.onload=function(){if(r("Controllo : "+t.addeded),l.readyState===l.DONE){r(t.addeded+" ha appena finito di caricare il documento"),t.pinged=Date.now();var d,f=l.responseXML;if(f instanceof HTMLDocument){if("json"===t.type){var g=n(e("body",f).text());g&&e("body",f).append(g)}e("script, iframe",f).remove(),d=e(t.selector,f)}if(!d||d.length<1)return r(t.addeded+" non ho trovato i marcatori, metto in review, esco !"),u(),b(t,chrome.i18n.getMessage("no_signature"),l.status),c(-1),!1;if(t.oldest=t.newest,t.newest=m(d),t.newest.length<1)return r(t.addeded+" ho i marcatori ma non i risultati, metto in review, esco !"),c(-3),u(),b(t,chrome.i18n.getMessage("no_results"),l.status),!1;var h=v(t.oldest,t.newest);s.update(a.elements,t).then(function(){r(t.addeded+" aggiornato"),t.oldest.length>0&&t.newest.length>0&&h.length>0?(r(t.addeded+" ci sono cambiamenti"),i?(x(t,h),r(t.addeded+" aggiunto a toWatch")):r(t.addeded+" non aggiunto a toWatch"),T(t.pinglist,h),o(t),u()):(o(t),u(),r(t.addeded+" non ci sono cambiamenti"))},function(e){c(-4),u(),b(t,chrome.i18n.getMessage("no_update")),r(t.addeded+", non riesco ad aggiornarlo : "+e)})}},l.onerror=function(){r(t.addeded+", errori di connessione !"),c(-5),u(),b(t,chrome.i18n.getMessage("connection_error"),l.status)},void l.send(null)):(c(-2),u(),r("Il link ha problemi : "+d),b(t,chrome.i18n.getMessage("no_link")+" "+d),!1)},R=function(t,n){if("object"!=typeof t||"object"!=typeof n)return!1;var i=!0;return e.each(t,function(e){return e in n?void 0:(i=!1,!1)}),i},E=function(t,n){if("object"!=typeof t||"object"!=typeof n)return null;var i={};return e.each(t,function(e){e in n&&(i[e]=t[e])}),e.extend({},n,i)},A=function(t){e.each(f,function(n,i){if(r("Fermo il listener "+i.interval),clearInterval(i.listener),t===!0){r("Avvio il listener "+i.interval);var o=function(){r("Eseguo il listener "+i.interval);var t=s.getTable(a.elements)||[];e.each(t,function(e,n){i.interval===n.interval&&(r("Eseguo il _elementJob per "+n.addeded),setTimeout(function(){N(n,!0,null,null,function(){e+1==t.length&&p()})},1e3))})};i.listener=setInterval(o,i.time),o()}})},L=function(t,n,i){"function"!=typeof i&&(i=function(){}),r("Prelevo le informazioni ..."),r(t),r(n),C(t,function(t){var o,a=t.responseXML;if(a instanceof HTMLDocument&&(o=e(a).find(n)),!o||o.length<1)return r("Ping ok, ma non ho elementi"),i("www");var c=m(o)||[];return r("Ping ok"),i(c)})},M={debug:function(e){o=e},settings:function(t,n,i,o){if(n=n||function(){},i=i||function(){},t){var c=E(t,u);if(!c)return r("Non posso aggiornare i sets, non è adeguato"),i(1e3),null;null===c["#"]?s.add(a.settings,c).then(function(){r("Settaggi aggiunti"),n()},function(){r("Non riesco a salvare i settaggi"),i()}):s.update(a.settings,c).then(function(){r("Settaggi aggiornati"),n()},function(){r("Non riesco a salvare i settaggi"),i()})}else{if(!o){var l=s.getTable(a.settings)||[];return l.length<1?e.extend({},u):l[0]}if(o===!0){var l=s.getTable(a.settings)||[],d=l.length<1?e.extend({},u):e.extend({},u,l[0]),f=this;r("Rimuovo i settaggi vecchi"),s.remove(a.settings,[0]).then(function(){r("Chiamo l'aggiornamento dei settaggi, merge"),d["#"]=null,f.settings(d)},function(){r("Non riesco a rimuovere i settaggi vecchi")})}}},itemProtoCollection:function(){var t=e.extend({},l);return t},onReviewChange:function(e){"function"==typeof e&&(w=function(t,n){r("Eseguo onReviewChange custom"),e(t,n)})},onWatchChange:function(e){"function"==typeof e&&(y=function(t,n){r("Eseguo onWatchChange custom"),e(t,n)})},onPayAttention:function(e){"function"==typeof e&&(p=function(){r("Eseguo il payAttention custom"),e(s.getTable(a.toReview),s.getTable(a.toWatch))})},startListeners:function(){A(!0)},stopListeners:function(){A()},getAllItems:function(){return s.getTable(a.elements)},getAllReviews:function(){return s.getTable(a.toReview)},getAllWatchs:function(){return s.getTable(a.toWatch)},getItem:function(e,t,n){s.query(a.elements,function(t){return 0==t.addeded.toString().localeCompare(e)}).then(t,n)},resetReview:function(e,t){e=e||function(){},t=t||function(){},s.clear(a.toReview).then(e,t)},resetWatch:function(e,t){e=e||function(){},t=t||function(){},s.clear(a.toWatch).then(e,t)},addItem:function(e,t,n,i){return t=t||"",n=n||function(){},i=i||function(){},R(e,l)?(e.addeded=Date.now(),void C(e.favicon,function(o){o&&200==o.status||(e.favicon="img/unknown.png"),s.add(a.elements,e).then(function(){r("Aggiunto il nuovo item "+e.addeded),localStorage["screenshot:"+e.addeded]=t,N(e),n()},function(){r("Non riesco ad aggiungere "+e.addeded+" nel database"),i()})})):(r("Non posso aggiungere il nuovo item, non è adeguato : "+e.page),i(1e3))},updateItem:function(e,t,n){return t=t||function(){},n=n||function(){},R(e,l)?void s.update(a.elements,e).then(function(){r("Aggiornato il nuovo item "+e.addeded),t()},function(){r("Non riesco ad aggiornare "+e.addeded+" nel database"),n()}):(r("Non posso aggiornare l'item, non è adeguato : "+e.page),n(1e3))},removeItem:function(e,t,n){t=t||function(){},n=n||function(){},s.remove(a.elements,e).then(function(){r("Item con id  "+e+" rimosso dal database"),t()},function(){r("Non riesco a rimuovere l'item con id "+e+" dal database"),n()})},getElements:function(e,t,n){r("Ricevo la richiesta degli elementi"),L(e,t,n)},updateResults:function(e,t,n){r("Ricevo la richiesta per aggiornare i risultati"),N(e,!1,t,n)}};e.extend(e,{Trimgle:M})}(window.jQuery,window.localdb,window.j2h);
//# sourceMappingURL=trimgle.min.js.map