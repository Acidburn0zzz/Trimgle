!function(n,t,e){"use strict";if(!n)throw new Error("jQuery required");if(!t)throw new Error("LocalDB required");if(!e)throw new Error("j2h required");var i="Timgle DB",o=!1,r=function(n){var n=(new Date).toLocaleString()+" : "+n;o===!0&&console.log(n)},c={settings:"Settings",elements:"Elements",toReview:"To Review",toWatch:"To Watch"},u={m1:6e4,m5:3e5,m15:9e5,m30:18e5,h1:36e5,h6:216e5,h12:432e5,h24:864e5},a={"#":null,notification:!0,sendAnonInfo:!0,lastNews:"https://www.facebook.com/Trimgle/",oldNews:""},s={"#":null,title:"",page:"",description:"",type:"html",favicon:"",selector:"",interval:"m30",newest:[],oldest:[],pinglist:[],addeded:0,pinged:0},f={title:"",link:"",text:""},l=new t({storage:localStorage,name:i,change:function(t,e,i,o){t==c.toReview?(b(i,o),r("_onReviewChange : "+t)):t==c.toWatch?(w(i,o),r("_onWatchChange : "+t)):t!=c.elements||"remove"!=i&&"clear"!=i||n.each(e,function(n,t){localStorage.removeItem("screenshot:"+t.addeded),r("Rimosso lo screenshot : "+t.addeded),l.query(c.toReview,function(n){return n.id==t.addeded}).then(function(n){r("Rimuovo toReview : "+n[0]["#"]),l.remove(c.toReview,n[0]["#"])}),l.query(c.toWatch,function(n){return n.id==t.addeded}).then(function(n){r("Rimuovo toWatch : "+n[0]["#"]),l.remove(c.toWatch,n[0]["#"])})})}}),g=[{interval:"m5",time:u.m5,listener:null},{interval:"m15",time:u.m15,listener:null},{interval:"m30",time:u.m30,listener:null},{interval:"h1",time:u.h1,listener:null}],d=function(n){return n?n.indexOf("#trimgle")>-1?n.replace(/\#trimgle/gi,""):n.indexOf("?")>-1?n.replace("?","?trimgle="+Date.now()+"&"):n.indexOf("#")>-1?n.replace("#","?trimgle="+Date.now()+"#"):n+"?trimgle="+Date.now():n},h=function(n){return n&&""!=n?n.replace(/(\?trimgle\=\d{0,100}&)/gi,"?").replace(/(\?trimgle\=\d{0,100}$)/gi,""):n},m=function(t){var e=[];return n.each(t,function(){var t=n(this).prop("tagName")||"";if(t&&""!=t){var i=n.extend({},f);"a"==t.toLowerCase()?(i.title=n(this).text()||"",i.title=i.title.trim(),i.link=n(this)[0].href||"",i.link=h(i.link.trim())):(i.text=n(this).text()||"",i.text=i.text.trim()),(""!=i.title&&""!=i.link||""!=i.text)&&e.push(i)}}),e},p=function(n,t){var e=function(n){return function(t){return 0==n.filter(function(n){return 0==n.link.localeCompare(t.link)&&0==n.title.localeCompare(t.title)&&0==n.text.localeCompare(t.text)}).length}},i=n.filter(e(t)),o=t.filter(e(n)),r=i.concat(o)||[];return r},v=function(){r("Eseguo il PayAttention vuoto")},b=function(){},w=function(){},y=function(n,t,e){t=t||"",e=e||0;var i=Date.now();l.add(c.toReview,{id:n.addeded,lasterror:t,status:e,when:i,title:n.title,page:n.page,desc:n.description,favicon:n.favicon}).then(function(){r(n.addeded+" inserito in review")},function(t){r(n.addeded+", non riesco ad inserirlo in review : "+t)})},S=function(t,e){if(!e)return!1;n.isArray(e)||(e=[e]);var i=Date.now();l.add(c.toWatch,{id:t.addeded,newdata:e,when:i,title:t.title,page:t.page,desc:t.description,favicon:t.favicon}).then(function(){r(t.addeded+" inserito in watchlist")},function(n){r(t.addeded+", non riesco ad inserirlo in watchlist : "+n)})},O=function(n,t){r("Chiamata al _ping() : "+n),"function"!=typeof t&&(t=function(){});var e=N();return(n=d(n))?(e.responseType="document",e.overrideMimeType("text/html"),e.open("GET",n,!0),e.onload=function(){r("ping ... : "+n),e.readyState===e.DONE&&t(e)},void e.send(null)):(t(),r("Il link ha problemi : "+n),!1)},j=function(t,e){r("Chiamata al _toPing()"),n.each(t,function(t,i){n.each(e,function(n,t){if(t.link.length>0&&t.title.length>0||t.text.length>0){var e=i.replace(/\{\%l\}/g,encodeURIComponent(t.link)).replace(/\{\%t\}/g,encodeURIComponent(t.title)).replace(/\{\%p\}/g,encodeURIComponent(t.text)).trim();setTimeout(function(){e&&""!=e&&O(e,function(){r("ping ok : "+e)})},1e3)}else r("Strano, ci sono elementi inconcruenti, vai in debug approfondito, grave !")})})},N=function(){try{return new XMLHttpRequest}catch(n){}try{return new ActiveXObject("Msxml3.XMLHTTP")}catch(n){}try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(n){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(n){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(n){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(n){}return null},x=function(t,i,o,u,a){i=i||!1,"function"!=typeof o&&(o=function(){}),"function"!=typeof u&&(u=function(){}),"function"!=typeof a&&(a=function(){});var s=N(),f=d(t.page);return f?(t.type=t.type||"html",s.responseType="document",s.overrideMimeType("text/html"),s.open("GET",f,!0),s.onload=function(){if(r("Controllo : "+t.addeded),s.readyState===s.DONE){r(t.addeded+" ha appena finito di caricare il documento"),t.pinged=Date.now();var f,g=s.responseXML;if(g instanceof HTMLDocument){if("json"===t.type){var d=e(n("body",g).text());d&&n("body",g).append(d)}n("script, iframe",g).remove(),f=n(t.selector,g)}if(!f||f.length<1)return r(t.addeded+" non ho trovato i marcatori, metto in review, esco !"),a(),y(t,chrome.i18n.getMessage("no_signature"),s.status),u(-1),!1;if(t.oldest=t.newest,t.newest=m(f),t.newest.length<1)return r(t.addeded+" ho i marcatori ma non i risultati, metto in review, esco !"),u(-3),a(),y(t,chrome.i18n.getMessage("no_results"),s.status),!1;var h=p(t.oldest,t.newest);l.update(c.elements,t).then(function(){r(t.addeded+" aggiornato"),t.oldest.length>0&&t.newest.length>0&&h.length>0?(r(t.addeded+" ci sono cambiamenti"),i?(S(t,h),r(t.addeded+" aggiunto a toWatch")):r(t.addeded+" non aggiunto a toWatch"),j(t.pinglist,h),o(t),a()):(o(t),a(),r(t.addeded+" non ci sono cambiamenti"))},function(n){u(-4),a(),y(t,chrome.i18n.getMessage("no_update")),r(t.addeded+", non riesco ad aggiornarlo : "+n)})}},s.onerror=function(){r(t.addeded+", errori di connessione !"),u(-5),a(),y(t,chrome.i18n.getMessage("connection_error"),s.status)},void s.send(null)):(u(-2),a(),r("Il link ha problemi : "+f),y(t,chrome.i18n.getMessage("no_link")+" "+f),!1)},T=function(t,e){if("object"!=typeof t||"object"!=typeof e)return!1;var i=!0;return n.each(t,function(n){return n in e?void 0:(i=!1,!1)}),i},M=function(t,e){if("object"!=typeof t||"object"!=typeof e)return null;var i={};return n.each(t,function(n){n in e&&(i[n]=t[n])}),n.extend({},e,i)},E=function(t){n.each(g,function(n,e){if(r("Fermo il listener "+e.interval),clearInterval(e.listener),t===!0){r("Avvio il listener "+e.interval);var i=function(n,t){if(n=n||l.getTable(c.elements),t=t||0,!n||n.length<1||t==n.length)return r("Ciclo workjob finito per "+e.interval),!1;r("Controllo se ci sono items per : "+e.interval);var o=n[t];e.interval===o.interval?(r("Eseguo '_elementJob' per "+t+" / "+e.interval),setTimeout(function(){x(o,!0,null,null,function(){r("Terminato '_elementJob' per "+t+" / "+e.interval),t+1==n.length&&v()}),setTimeout(function(){i(n,t+1)},3e3)},100)):i(n,t+1)};e.listener=setInterval(i,e.time),i()}})},C=function(t,e,i){"function"!=typeof i&&(i=function(){}),r("Prelevo le informazioni ..."),r(t),r(e),O(t,function(t){var o,c=t.responseXML;if(c instanceof HTMLDocument&&(o=n(c).find(e)),!o||o.length<1)return r("Ping ok, ma non ho elementi"),i("www");var u=m(o)||[];return r("Ping ok"),i(u)})},k={debug:function(n){o=n},settings:function(t,e,i,o){if(e=e||function(){},i=i||function(){},t){var u=M(t,a);if(!u)return r("Non posso aggiornare i sets, non è adeguato"),i(1e3),null;null===u["#"]?l.add(c.settings,u).then(function(){r("Settaggi aggiunti"),e()},function(){r("Non riesco a salvare i settaggi"),i()}):l.update(c.settings,u).then(function(){r("Settaggi aggiornati"),e()},function(){r("Non riesco a salvare i settaggi"),i()})}else{if(!o){var s=l.getTable(c.settings)||[];return s.length<1?n.extend({},a):s[0]}if(o===!0){var s=l.getTable(c.settings)||[],f=s.length<1?n.extend({},a):n.extend({},a,s[0]),g=this;r("Rimuovo i settaggi vecchi"),l.remove(c.settings,[0]).then(function(){r("Chiamo l'aggiornamento dei settaggi, merge"),f["#"]=null,g.settings(f)},function(){r("Non riesco a rimuovere i settaggi vecchi")})}}},itemProtoCollection:function(){var t=n.extend({},s);return t},onReviewChange:function(n){"function"==typeof n&&(b=function(t,e){r("Eseguo onReviewChange custom"),n(t,e)})},onWatchChange:function(n){"function"==typeof n&&(w=function(t,e){r("Eseguo onWatchChange custom"),n(t,e)})},onPayAttention:function(n){"function"==typeof n&&(v=function(){r("Eseguo il payAttention custom"),n(l.getTable(c.toReview),l.getTable(c.toWatch))})},startListeners:function(){E(!0)},stopListeners:function(){E()},getAllItems:function(){return l.getTable(c.elements)},getAllReviews:function(){return l.getTable(c.toReview)},getAllWatchs:function(){return l.getTable(c.toWatch)},getItem:function(n,t,e){l.query(c.elements,function(t){return 0==t.addeded.toString().localeCompare(n)}).then(t,e)},resetReview:function(n,t){n=n||function(){},t=t||function(){},l.clear(c.toReview).then(n,t)},resetWatch:function(n,t){n=n||function(){},t=t||function(){},l.clear(c.toWatch).then(n,t)},addItem:function(n,t,e,i){return t=t||"",e=e||function(){},i=i||function(){},T(n,s)?(n.addeded=Date.now(),void O(n.favicon,function(o){o&&200==o.status||(n.favicon="img/unknown.png"),l.add(c.elements,n).then(function(){r("Aggiunto il nuovo item "+n.addeded),localStorage["screenshot:"+n.addeded]=t,x(n),e()},function(){r("Non riesco ad aggiungere "+n.addeded+" nel database"),i()})})):(r("Non posso aggiungere il nuovo item, non è adeguato : "+n.page),i(1e3))},updateItem:function(n,t,e){return t=t||function(){},e=e||function(){},T(n,s)?void l.update(c.elements,n).then(function(){r("Aggiornato il nuovo item "+n.addeded),t()},function(){r("Non riesco ad aggiornare "+n.addeded+" nel database"),e()}):(r("Non posso aggiornare l'item, non è adeguato : "+n.page),e(1e3))},removeItem:function(n,t,e){t=t||function(){},e=e||function(){},l.remove(c.elements,n).then(function(){r("Item con id  "+n+" rimosso dal database"),t()},function(){r("Non riesco a rimuovere l'item con id "+n+" dal database"),e()})},getElements:function(n,t,e){r("Ricevo la richiesta degli elementi"),C(n,t,e)},updateResults:function(n,t,e){r("Ricevo la richiesta per aggiornare i risultati"),x(n,!1,t,e)}};n.extend(n,{Trimgle:k})}(window.jQuery,window.localdb,window.j2h);
//# sourceMappingURL=trimgle.min.js.map